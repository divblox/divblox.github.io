(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{158:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return l})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return u})),n.d(t,"default",(function(){return b}));var a=n(2),i=n(9),o=(n(0),n(189)),r=n(191),c=(n(197),n(198),n(194)),l={id:"basic-training-exercise",title:"Basic Training Exercise"},s={id:"basic-training-exercise",isDocsHomePage:!1,title:"Basic Training Exercise",description:"checkUrlScroll();",source:"@site/docs/basic-training-exercise.mdx",permalink:"/docs/basic-training-exercise",sidebar:"someSidebar",previous:{title:"Divblox Best Practices",permalink:"/docs/divblox-best-practices"},next:{title:"Basic Training Evaluation",permalink:"/docs/basic-training-evaluation"}};Object(c.a)();var u=[{value:"Introduction",id:"introduction",children:[]},{value:"Step 1 - Data Model",id:"step-1---data-model",children:[]},{value:"Step 2 - CRUD Components",id:"step-2---crud-components",children:[]},{value:"Step 3 - Page Components",id:"step-3---page-components",children:[]},{value:"Step 4 - Navigation bar",id:"step-4---navigation-bar",children:[]},{value:"Step 5 - Global Functions",id:"step-5---global-functions",children:[{value:"Step 5.1 - Adding button",id:"step-51---adding-button",children:[]},{value:"Step 5.2 - Create global function",id:"step-52---create-global-function",children:[]},{value:"Step 5.3 - Call global function",id:"step-53---call-global-function",children:[]},{value:"Step 5.4 - Add JavaScript",id:"step-54---add-javascript",children:[]}]},{value:"Step 6 - Security",id:"step-6---security",children:[]},{value:"Step 7 - Exposing an API",id:"step-7---exposing-an-api",children:[]},{value:"Step 8 - Further Examples",id:"step-8---further-examples",children:[{value:"Custom Component Setup",id:"custom-component-setup",children:[]},{value:"Function 1",id:"function-1",children:[]},{value:"Function 2",id:"function-2",children:[]},{value:"Function 3",id:"function-3",children:[]},{value:"Function 4",id:"function-4",children:[]},{value:"Function 5",id:"function-5",children:[]},{value:"Function 6",id:"function-6",children:[]},{value:"Function 7",id:"function-7",children:[]},{value:"Final Optimizations",id:"final-optimizations",children:[]}]},{value:"Summary",id:"summary",children:[]}],d={rightToc:u};function b(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},d,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"This exercise assumes that you have managed to configure your Divblox project and that you understand the basic concepts.\nIf you are not sure that you do understand the basics, you can look at the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"common-examples-hello-world-example"}),"common examples"),"."),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"In this exercise we will go into a bit more detail about the main Divblox concepts that are used in every project.\nThese concepts include:")),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Data modeling"),Object(o.b)("li",{parentName:"ul"},"The Divblox ORM (Object Relational Mapping)"),Object(o.b)("li",{parentName:"ul"},"Interaction between a component's front-end and back-end"),Object(o.b)("li",{parentName:"ul"},"Component and object security"),Object(o.b)("li",{parentName:"ul"},"Exposing an API")),Object(o.b)("h2",{id:"introduction"},"Introduction"),Object(o.b)("p",null,'In this training exercise, we will be creating a basic ticketing system that will allow users to create and manage "tickets". To allow users to interact with our tickets, we will generate CRUD (Create, Read, Update, Delete) components.'),Object(o.b)("p",null,"Additionally, we will create the following components:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"A page where full CRUD of tickets and categories is done"),Object(o.b)("li",{parentName:"ul"},"A page where we reuse the CREATE component for a ticket to allow the user to create tickets in a simple way")),Object(o.b)("p",null,"We will also be building some custom functionality to demonstrate how to communicate between the front-end and back-end of a Divblox application."),Object(o.b)("p",null,"Finally, we will also learn how to secure our components and data model entities, as well as how to expose our functionality via the Divblox API layer."),Object(o.b)("h2",{id:"step-1---data-model"},"Step 1 - Data Model"),Object(o.b)("p",null,"We will be creating a data model with the following entities and attributes:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"Ticket"),": TicketName, TicketDescription, TicketDueDate, TicketUniqueId, TicketStatus"),Object(o.b)("li",{parentName:"ul"},Object(o.b)("strong",{parentName:"li"},"Category"),": CategoryLabel")),Object(o.b)("p",null,"This can be represented as follows:"),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"UML diagram",src:Object(r.a)("_basic-training-media/training-exercise1.png")})),Object(o.b)("p",null,"If you need a refresh on Divblox data modelling, click ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"the-basics-data-modeler"}),"here"),". Below is a walk-through of how to add the necessary entities using Divblox's Data Modeller."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-1.1.mp4"),type:"video/mp4"})),Object(o.b)("h2",{id:"step-2---crud-components"},"Step 2 - CRUD Components"),Object(o.b)("p",null,"Now that our data model is created and synchronized with our database,\nlet's generate some CRUD components (using the component builder) for ",Object(o.b)("inlineCode",{parentName:"p"},"Ticket")," and ",Object(o.b)("inlineCode",{parentName:"p"},"Category"),". Below is a walk-through of how to create full CRUD functionality for the ",Object(o.b)("inlineCode",{parentName:"p"},"Category")," entity."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-2.1.mp4"),type:"video/mp4"})),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"And now we will create the CRUD functionality for the ",Object(o.b)("inlineCode",{parentName:"p"},"Ticket")," entity, which although more complex, is just as easy with Divblox.")),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-2.2.mp4"),type:"video/mp4"})),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"When checking the ",Object(o.b)("inlineCode",{parentName:"p"},"Validate")," checkbox, Divblox automatically notifies the user that input is required. Further validations can be added at a later stage.")),Object(o.b)("p",null,"Notice that in both examples we did not tick the ",Object(o.b)("inlineCode",{parentName:"p"},"Constrain To")," checkbox. If you constrain by a certain attribute, you are filtering to see only results that satisfy that criteria. An example would be to constrain Tickets by the current user account. This will display only tickets created by the current user. These constraints can only be done with entities that have a singular relationship. Singular relationships mean that an entity instance is linked to one, and only one, instance of another entity. E.g. Each ticket can only be linked to one account at any given time."),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Singular relationship",src:Object(r.a)("_basic-training-media/bte-3-1.png")})),Object(o.b)("p",null,"This logic also applies when using 'create' and 'update' functionality and using the ",Object(o.b)("inlineCode",{parentName:"p"},"Constrain By")," checkbox. An example here would be to automatically link a ticket to the current user upon creation."),Object(o.b)("p",null,"You may want to change the display of certain attributes, in all of the components they feature. In our example, let's say we have a set predetermined list of ticket statuses the user should be able to chose from. This can be manually done in the ",Object(o.b)("inlineCode",{parentName:"p"},"data_lists.json")," and ",Object(o.b)("inlineCode",{parentName:"p"},"entity_definitions.json")," files. A walk-through of this is shown in the below video."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-2.3.mp4"),type:"video/mp4"})),Object(o.b)("h2",{id:"step-3---page-components"},"Step 3 - Page Components"),Object(o.b)("p",null,"In order for us to be able to use our newly generated CRUD components, or any other component for that matter, we need to put them inside pages.\nPages are also just components, but they can be navigated to by the user in the browser, while individual components can not."),Object(o.b)("p",null,'!>A component is considered a page component when it is located in the "pages" grouping (the folder /project/components/pages/',"[component_name]",")"),Object(o.b)("p",null,"The pages we will build for this exercise are:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"An admin page where our full CRUD components can live"),Object(o.b)("li",{parentName:"ul"},'A "New Ticket" page where users can create new tickets')),Object(o.b)("p",null,"To do this we will use a pre-made page template with a side navbar. As you will see, the navigation bar is pre-populated with links we will later override or delete to suite our needs."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-3.1.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"Now we can create the 'Tickets' page where users can create tickets. Note that we are not creating any new functionality, just reusing the 'create' component previously generated and placing it on its own page."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-3.2.mp4"),type:"video/mp4"})),Object(o.b)("h2",{id:"step-4---navigation-bar"},"Step 4 - Navigation bar"),Object(o.b)("p",null,"Ok, we now have components that allow us to create our data, as well as pages to view them on. We will now update the side navigation bar to function as we want it to. Notice how, in this video, we edit the component code in our IDE (any IDE/text editor of your choice). The preferred way is to use an IDE, but for quick fixes like changing the HTML layout of our page we can use Divblox's built-in code editor. The process followed here is as follows:"),Object(o.b)("p",null,"Divblox incorporates an easy to use seperation between the actual navigation bars and the menu items in them. The idea of this is to allow for reusabililty of the same menus and styiling throughout a project. You can access the list of menus available in your project from the ",Object(o.b)("inlineCode",{parentName:"p"},"Navigation")," bar in the setup page."),Object(o.b)("p",null,"You will see the following:"),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Navigation Menu",src:Object(r.a)("_basic-training-media/navigation-menu.png")})),Object(o.b)("p",null,"There are a few default menus, and we will create a basic-training-exercise-menu with the necessary items."),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Navigation Menu Modal",src:Object(r.a)("_basic-training-media/navigation-menu-modal.png")})),Object(o.b)("p",null,"Here we add the HTML that we want to be displayed as our item, in our case we want an icon and page name. We give our two pages the following:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-html"}),'\x3c!-- ADMIN --\x3e\n<i class="fa fa-home" aria-hidden="true"></i>\n<br />\nAdmin\n\n<--! New Ticket --\x3e\n<i class="fa fa-link" aria-hidden="true"></i>\n<br />\nNew Ticket\n')),Object(o.b)("p",null,"We also set the action we want to occur when clicking on the menu item to load up the corresponding page. The navigation bar component HTML looks like this:"),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Navigation Menu HTML",src:Object(r.a)("_basic-training-media/navigation-menu-html.png")})),Object(o.b)("h2",{id:"step-5---global-functions"},"Step 5 - Global Functions"),Object(o.b)("p",null,"For the purposes of this exercise, we want to assign a unique ID to every ticket. This will allow us later on to retrieve\ninformation about our ticket via an API. To generate this unique ID, we will make use of a global function call."),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"Global functions are defined for functionality that will be used multiple times, reducing code duplication"))),Object(o.b)("blockquote",null,Object(o.b)("p",{parentName:"blockquote"},"We will create the unique ID in the backend, as we need to verify whether or not it is indeed unique by checking our database.")),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Flowchart of frontend/backend communication",src:Object(r.a)("_basic-training-media/basic-training-exercise-step5.png")})),Object(o.b)("h3",{id:"step-51---adding-button"},"Step 5.1 - Adding button"),Object(o.b)("p",null,"Add the button in our ",Object(o.b)("inlineCode",{parentName:"p"},"ticket_crud_create")," component that will generate a unique ID and populate the input box. We can do this through the Divblox Component Builder or in the source code."),Object(o.b)("p",null,"Below is a video running through step 1:"),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-5.1.mp4"),type:"video/mp4"})),Object(o.b)("h3",{id:"step-52---create-global-function"},"Step 5.2 - Create global function"),Object(o.b)("p",null,"Create the global php function that will generate the unique ID in ",Object(o.b)("inlineCode",{parentName:"p"},"project_functions.php"),"."),Object(o.b)("h3",{id:"step-53---call-global-function"},"Step 5.3 - Call global function"),Object(o.b)("p",null,"Call the global function from ",Object(o.b)("inlineCode",{parentName:"p"},"component.php"),", sending information to the front end."),Object(o.b)("p",null,"Below is a video running through step 2 and 3:"),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-5.2.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"Here is the code added into the class ProjectFunctions, in ",Object(o.b)("inlineCode",{parentName:"p"},"project/assets/php/project_functions.php"),"."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"public static function getNewTicketUniqueId() {\n        $CandidateStr = self::generateRandomString(24);\n        $DoneBool = false;\n        while(!$DoneBool) {\n            // Divblox query language to load a ticket from the database,\n            // based on the UniqueId field\n            $ExistingTicketCount = Ticket::LoadByTicketUniqueId($CandidateStr);\n            if ($ExistingTicketCount == 0) {\n                $DoneBool = true;\n            } else {\n                $CandidateStr = self::generateRandomString(24);\n            }\n        }\n        return $CandidateStr;\n    }\n")),Object(o.b)("p",null,"And the code added into the ",Object(o.b)("inlineCode",{parentName:"p"},"ticket_crud_create")," component.php file:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'// The function on our component controller that will return a new unique ticket ID for us.\n// This function is executed when we pass "getNewTaskUniqueId" as\n// the value for "f" from our component JavaScript\npublic function getNewTicketUniqueId() {\n        // setReturnValue() sets the values in an array that will be returned as JSON\n        //when the script completes. We always need to set the value for "Result" to either\n        // "Success" or "Failed" in order for the component JavaScript to know\n        // how to treat the response\n        $this->setResult(true);\n        // It is always a good idea to populate a "Message" for the front-end\n        $this->setReturnValue("Message", "New unique ID created");\n        // Here we set the value of any additional parameters to return\n        $this->setReturnValue("TicketId", ProjectFunctions::getNewTicketUniqueId());\n        // "presentOutput()" returns our array as JSON and stops any\n        // further execution of the current php script\n        $this->presentOutput();\n    }\n')),Object(o.b)("h3",{id:"step-54---add-javascript"},"Step 5.4 - Add JavaScript"),Object(o.b)("p",null,"Add the JavaScript functionality that auto-populates the input box with the newly generated unique ID in ",Object(o.b)("inlineCode",{parentName:"p"},"component.js"),"."),Object(o.b)("p",null,"Below is a video of step 4:"),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step5.3.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"The code added into the ",Object(o.b)("inlineCode",{parentName:"p"},"initCustomFunctions")," function was:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),'// dxRequestInternal() is the global function used to communicate\n// from the component\'s JavaScript to its back-end php component\ndxRequestInternal(\n    // The first parameter tells the function where to send the request\n    // getComponentControllerPath(this) returns the path to current component\'s php script\n    getComponentControllerPath(this),\n    // Tell component.php which function to execute\n    { f: "getNewTaskUniqueId" },\n    function (data_obj) {\n        // Success function\n        getComponentElementById(this, "TicketUniqueId").val(data_obj.TaskId);\n    }.bind(this),\n    function (data_obj) {\n        // Fail function\n    }.bind(this)\n);\n')),Object(o.b)("h2",{id:"step-6---security"},"Step 6 - Security"),Object(o.b)("p",null,"It is important to understand how Divblox user roles are used to control access to the application. Divblox has two forms of access:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("em",{parentName:"li"},"Component access")," allows the user to view the components"),Object(o.b)("li",{parentName:"ul"},Object(o.b)("em",{parentName:"li"},"Data Model")," access gives the user permissions to perform CRUD operations on specific entities defined in the data model.")),Object(o.b)("p",null,"By default, there are two user roles."),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Administrator - Has access to all components and full CRUD functionality."),Object(o.b)("li",{parentName:"ol"},"User - This is the user role allocated to anyone who registers on your app. The default access is only to your profile and account.")),Object(o.b)("p",null,'Any user that is not authenticated is treated as "Anonymous" - No access, gets redirected to the anonymous landing page.'),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"Additional user roles can be defined in the data modeller."))),Object(o.b)("p",null,"It is important to define a user role hierarchy in the abstract class 'UserRoleHierarchy' (project/assets/php/user_role_hierarchy.class.php), so as to prevent duplicate writing of components and data model access for different user types. This allows for user roles to inherit access from lower user roles, so you only need to specify what access the user role has above and beyond previously defined access."),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"UserRoleHierarchy",src:Object(r.a)("_basic-training-media/userrole-hierarchy.jpg")})),Object(o.b)("p",null,"The Component default settings are as follows:"),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Component Access",src:Object(r.a)("_basic-training-media/basic-training-exercise-component-access.png")})),Object(o.b)("p",null,"And the Data Model settings seen below. It is also important to note that by default users are able to ",Object(o.b)("inlineCode",{parentName:"p"},"create")," and ",Object(o.b)("inlineCode",{parentName:"p"},"read")," data, even if not explicitly stated in the ",Object(o.b)("inlineCode",{parentName:"p"},"$AccessArray"),"."),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Data Model Access",src:Object(r.a)("_basic-training-media/basic-training-exercise-data-model-access.png")})),Object(o.b)("p",null,"For our exercise we created 2 pages (The 'admin' and 'new ticket' pages). Let's assume that we only want administrators to access the admin page."),Object(o.b)("p",null,"You can access the register page by navigating to ",Object(o.b)("inlineCode",{parentName:"p"},"[your_project_root]/?view=register"),'. New users are registered with the user role "User" by default.'),Object(o.b)("p",null,"!> It is also good practice to test user role access in incognito/private mode, as you are typically logged in as a Divblox admin (dxAdmin) most of the time in your application and this may cause confusion."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-6.1.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"As you can see, our new user is unable to view any of the pages we built. This is because he does not have component access to the components on those pages. We will change that in the ",Object(o.b)("inlineCode",{parentName:"p"},"ComponentRoleBasedAccessArray::$AccessArray"),"."),Object(o.b)("p",null,"In the below video we will firstly give our user full access to any ",Object(o.b)("inlineCode",{parentName:"p"},"Ticket")," and ",Object(o.b)("inlineCode",{parentName:"p"},"Category")," components. This will allow us to see how the ",Object(o.b)("em",{parentName:"p"},"Data Model")," access works (we will observe this on our admin page). Once the ",Object(o.b)("em",{parentName:"p"},"Data Model")," access is configured, we will then give our user access only to the ",Object(o.b)("inlineCode",{parentName:"p"},"create")," components of both ",Object(o.b)("inlineCode",{parentName:"p"},"Ticket")," and ",Object(o.b)("inlineCode",{parentName:"p"},"Category"),", allowing the user to view the ",Object(o.b)("em",{parentName:"p"},"New Ticket")," page, but not the admin page."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-6.2.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"It is worth noting that this is a basic example to demonstrate how Divblox handles user access. As you may have seen above, there is no need to change the ",Object(o.b)("em",{parentName:"p"},"Data Model")," access of our user to be able to ",Object(o.b)("inlineCode",{parentName:"p"},"update")," and ",Object(o.b)("inlineCode",{parentName:"p"},"delete")," as he will never be able to get to the admin page to do this."),Object(o.b)("h2",{id:"step-7---exposing-an-api"},"Step 7 - Exposing an API"),Object(o.b)("p",null,"Now that we have all the groundwork completed, let's provide the world with an API endpoint that will allow us to do some custom functionality on our tickets. To do this, we will copy the provided ",Object(o.b)("inlineCode",{parentName:"p"},"api_example")," endpoint and modify it for our use case. The API functionality we want to achieve is as follows:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Allow a user to provide us with an array of unique ticket IDs as input"),Object(o.b)("li",{parentName:"ul"},"Select only the ticket descriptions from the tickets"),Object(o.b)("li",{parentName:"ul"},"Merge all of the ticket descriptions into the first ticket (initial unique ID)"),Object(o.b)("li",{parentName:"ul"},"Delete the remaining tickets"),Object(o.b)("li",{parentName:"ul"},"Return the new merged ticket as output")),Object(o.b)("p",null,"We will be using a program called 'PostMan' to test our API functionality. It comes pre-installed on the Divblox VM image."),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"Divblox automatically handles the routing for your API endpoint. API endpoints are available at ","[your_project_root]","/api/","[endpoint_name]"))),Object(o.b)("p",null,"Below we will briefly explore the ",Object(o.b)("inlineCode",{parentName:"p"},"api_example")," functionality, how to navigate the URL and what the expected output looks like."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-7.1.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"To proceed, we will create a file ",Object(o.b)("inlineCode",{parentName:"p"},"basic_training_exercise.php")," in ",Object(o.b)("inlineCode",{parentName:"p"},"project/api")," and mimic the basic structure of an API endpoint like in ",Object(o.b)("inlineCode",{parentName:"p"},"api_example.php"),". Firstly, we add an API operation with function name",Object(o.b)("inlineCode",{parentName:"p"},"mergeTickets();"),"."),Object(o.b)("p",null,"In the ",Object(o.b)("inlineCode",{parentName:"p"},"mergeTickets();")," function we code the following logic:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"check if the input is valid JSON"),Object(o.b)("li",{parentName:"ul"},"check if the master unique ID exists"),Object(o.b)("li",{parentName:"ul"},"check if the master unique ID is valid"),Object(o.b)("li",{parentName:"ul"},"check if there are more than two IDs"),Object(o.b)("li",{parentName:"ul"},"if there is more than two IDs:",Object(o.b)("ul",{parentName:"li"},Object(o.b)("li",{parentName:"ul"},"loop through the valid IDs"),Object(o.b)("li",{parentName:"ul"},"perform a merging of the ticket descriptions"),Object(o.b)("li",{parentName:"ul"},"delete each ticket after its description is merged"))),Object(o.b)("li",{parentName:"ul"},"save the results into the database"),Object(o.b)("li",{parentName:"ul"},"present output to front end")),Object(o.b)("p",null,"The code added into our 'basic_training_exercise.php' endpoint (",Object(o.b)("inlineCode",{parentName:"p"},"/project/api/basic_training_exercise.php"),") is the following:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'require("../../divblox/divblox.php");\n// Start by declaring your operations and then calling the initApi function.\n// This is important for your API documentation to be automatically generated at run-time\nPublicApi::addApiOperation("mergeTickets",\n    // Specify the various input parameters as an array\n    ["input_ids"],\n    // Specify the various expected output parameters as an associative array\n    ["merged_ticket" => "[JSON object representing new merged ticket]"],\n    // Give your operation a name\n    "Merge Tickets",\n    // Give your operation a description\n    "This operation will merge an array of tickets into a combined ticket with the unique\n    ID of the first ticket. input_ids should be a JSON encoded array of unique ticket IDs");\n\n// Describes the "entire" API endpoint\nPublicApi::initApi("API endpoint to demonstrate our basic training exercise functionality",\n                  "Basic Training Exercise");\n// Operation\nfunction mergeTickets() {\n    // More information on functions available in the public API class\n    // is provided in the API documentation section\n    $InputIdArrayStr = PublicApi::getInputParameter("input_ids");\n    if (!ProjectFunctions::isJson($InputIdArrayStr)) {\n        PublicApi::setApiResult(false);\n        PublicApi::addApiOutput("Message","Invalid value for input_ids provided.");\n        PublicApi::printApiResult();\n    }\n    $InputIdArray = json_decode($InputIdArrayStr);\n    if (!isset($InputIdArray[0])) {\n        PublicApi::setApiResult(false);\n        PublicApi::addApiOutput("Message","Invalid value for input_ids provided.");\n        PublicApi::printApiResult();\n    }\n    $MasterTicketObj = Ticket::LoadByTicketUniqueId($InputIdArray[0]);\n    if (is_null($MasterTicketObj)) {\n        PublicApi::setApiResult(false);\n        PublicApi::addApiOutput("Message","Invalid input ID for master ticket");\n        PublicApi::printApiResult();\n    }\n    $InputIdArraySizeInt = ProjectFunctions::getDataSetSize($InputIdArray);\n    if ($InputIdArraySizeInt < 2) {\n        PublicApi::setApiResult(true);\n        PublicApi::addApiOutput("merged_ticket", json_decode($MasterTicketObj->getJson()));\n        PublicApi::printApiResult();\n    }\n    for ($i = 1; $i < $InputIdArraySizeInt; $i++) {\n        $TicketObj = Ticket::LoadByTicketUniqueId($InputIdArray[$i]);\n        if (is_null($TicketObj)) {\n            continue;\n        }\n        $MasterTicketObj->TicketDescription .= $TicketObj->TicketDescription;\n        $TicketObj->Delete();\n    }\n    $MasterTicketObj->Save();\n    PublicApi::setApiResult(true);\n    PublicApi::addApiOutput("merged_ticket", json_decode($MasterTicketObj->getJson()));\n    PublicApi::printApiResult();\n}\n')),Object(o.b)("p",null,"Once we have defined our endpoint, we can test to see if everything works. Note that this specific API operation updates and deletes data in our database, we need to update the ",Object(o.b)("inlineCode",{parentName:"p"},"Data Model")," permissions so that 'any' users can 'update' and 'delete' (Recall that default permissions are only to 'create' and 'read'). Once this is done, our API operation should be set up and permissions for operations granted. We use Postman this time, as it makes it easier to input parameters and has a great user interface."),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-7.3.mp4"),type:"video/mp4"})),Object(o.b)("h2",{id:"step-8---further-examples"},"Step 8 - Further Examples"),Object(o.b)("p",null,"In the following examples, you will gain a deeper understanding of the Divblox PHP query language that is used to communicate with the database. We will also be building on your existing knowledge on how to communicate between the frontend and backend of your Divblox application."),Object(o.b)("div",{className:"admonition admonition-info alert alert--info"},Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-heading"}),Object(o.b)("h5",{parentName:"div"},Object(o.b)("span",Object(a.a)({parentName:"h5"},{className:"admonition-icon"}),Object(o.b)("svg",Object(a.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(o.b)("path",Object(a.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(o.b)("div",Object(a.a)({parentName:"div"},{className:"admonition-content"}),Object(o.b)("p",{parentName:"div"},"In this section we will focus on the dxQuery language explained ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"the-basics-data-modeler#orm-code-generation"}),"here"),"."))),Object(o.b)("p",null,"You will build the following:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"A custom component that will serve as a container for some example functions. This component will manage the communication between frontend and backend"),Object(o.b)("li",{parentName:"ul"},"Function 1: An example of how to generate dummy data"),Object(o.b)("li",{parentName:"ul"},"Function 2: Basic dxQuery example using ",Object(o.b)("inlineCode",{parentName:"li"},"QueryArray()")),Object(o.b)("li",{parentName:"ul"},"Function 3: A slightly more advanced dxQuery example using query conditions like ",Object(o.b)("inlineCode",{parentName:"li"},"dxQ::AndCondition()")," and ",Object(o.b)("inlineCode",{parentName:"li"},"dxQ::Equal()")),Object(o.b)("li",{parentName:"ul"},"Function 4: Even more advanced example that makes use of Divblox's wrappers for PHP's DateTime class"),Object(o.b)("li",{parentName:"ul"},"Function 5: Example of building up a query result in a loop"),Object(o.b)("li",{parentName:"ul"},"Function 6: More advanced example of building a query result in a loop"),Object(o.b)("li",{parentName:"ul"},"Function 7: Optimization of function 6"),Object(o.b)("li",{parentName:"ul"},"Lastly, we will optimize our code for extremely large datasets")),Object(o.b)("h3",{id:"custom-component-setup"},"Custom Component Setup"),Object(o.b)("p",null,'Create a custom component with two equally sized columns. In the left column we will house three elements, namely a drop down list of functions to select, an additional input box and a button to execute the chosen functionality. In the right column we will just create and empty div with ID = "ResultWrapper" so we can instruct ',Object(o.b)("inlineCode",{parentName:"p"},"dxRequestInternal()")," where to display any output. Below is a video walk through of the process:"),Object(o.b)("video",{width:"100%",height:"100%",playsInline:!0,muted:!0,loop:!0,poster:Object(r.a)("img/video-placeholder.png"),preload:"true",controls:!0},Object(o.b)("source",{src:Object(r.a)("_basic-training-media/bte-step-8.1.mp4"),type:"video/mp4"})),Object(o.b)("p",null,"It is important to create a div in the right column so you can tell ",Object(o.b)("inlineCode",{parentName:"p"},"dxInternalRequest()")," where to return any output."),Object(o.b)("p",null,"Next, we will set up our component JavaScript to send the selected function (and include the additional output if required) to the backend, and return whatever output the function provided to the front end."),Object(o.b)("p",null,"We will again be using the ",Object(o.b)("inlineCode",{parentName:"p"},"dxRequestInternal")," function for backend/frontend communication."),Object(o.b)("p",null,"The code that replaces the default 3 second loading function for our button is:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-javascript"}),'dxRequestInternal(\n    getComponentControllerPath(this),\n    {\n        // We specifically named the values of the drop down the same as\n        // the functions to execute, so we can just use the value of input box\n        f: getComponentElementById(this, "8LSBQ_FormControlSelect").val(),\n        additional_input: getComponentElementById(\n            this,\n            "H7u7b_FormControlInput"\n        ).val(),\n    },\n    function (data_obj) {\n        // Success Function\n        // Returns (in JSON format) backend function output\n        // in div with id="ResultWrapper"\n        getComponentElementById(this, "ResultWrapper").html(\n            JSON.stringify(data_obj.ReturnData)\n        );\n    }.bind(this),\n    function (data_obj) {\n        // Failure Function\n        // Nothing set here right now\n    }.bind(this),\n    false,\n    // Set loading text of button while function executes\n    getComponentElementById(this, "dfVzo_btn"),\n    "Executing " +\n        getComponentElementById(this, "8LSBQ_FormControlSelect").val()\n);\n')),Object(o.b)("p",null,"We should now be set! Our custom component is ready, our input selection is set up and we have a div to display our output. What remains now is to define our 7 functions."),Object(o.b)("h3",{id:"function-1"},"Function 1"),Object(o.b)("strong",null,"Generate data: This function will generate a bunch of categories & accounts, then it will generate a bunch of tickets, linked to a random category with a random status, account & due date "),Object(o.b)("p",null,"Here we use the built in PHP function ",Object(o.b)("inlineCode",{parentName:"p"},"rand()"),", as well as a bit of Divblox functionality, including the ",Object(o.b)("inlineCode",{parentName:"p"},"dxDateTime()")," class as well as the ",Object(o.b)("inlineCode",{parentName:"p"},"generateRandomString()")," and ",Object(o.b)("inlineCode",{parentName:"p"},"generateTimeBasedString()")," functions. If you are not comfortable with these, you can refer to the class/function definitions."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'public function Function1() {\n    // Set how many of each we want to generate\n    $AccountDataSize = 50;\n    $CategoryDataSize = 8;\n    $TicketDataSize = 500;\n    $TicketStatusArray = ["New", "In Progress", "Backlog", "Urgent", "Completed"];\n\n    // Note that you need an initial account and category for this to work\n    for ($i = 0; $i < $TicketDataSize; $i++) {\n        // Fill the Ticket object with necessary values and save into database\n        $TicketObj = new Ticket();\n        $TicketObj->TicketName = ProjectFunctions::generateRandomString(8);\n        $TicketObj->TicketDescription = ProjectFunctions::generateRandomString(100);\n        $TicketObj->TicketStatus = $TicketStatusArray[rand(0,4)];\n        // dxDateTime has prebuilt functionality for working with dates,\n        // all we are doing is making the DueDate a random date between\n        // tomorrow and 20 days from now.\n        $TicketObj->TicketDueDate = dxDateTime::Now()->AddDays(rand(1,20));\n        // Load a random value from existing Account and Category Entities\n        $TicketObj->AccountObject = Account::Load(rand(0,Account::CountAll()-1));\n        $TicketObj->CategoryObject = Category::Load(rand(0,Category::CountAll()-1));\n        $TicketObj->Save();\n        if ($i >= $AccountDataSize) {\n            continue;\n        }\n        // Fill the Account object with necessary values and save into database\n        $AccountObj = new Account();\n        $AccountObj->FirstName = ProjectFunctions::generateRandomString(8);\n        $AccountObj->LastName = ProjectFunctions::generateRandomString(8);\n        $AccountObj->FullName = $AccountObj->FirstName." ".$AccountObj->LastName;\n        $AccountObj->EmailAddress = ProjectFunctions::generateTimeBasedRandomString();\n        $AccountObj->Username = $AccountObj->EmailAddress;\n        $AccountObj->Save();\n        if ($i >= $CategoryDataSize) {\n            continue;\n        }\n        //Fill the Category object with necessary values and save into database\n        $CategoryObj = new Category();\n        $CategoryObj->CategoryLabel = ProjectFunctions::generateTimeBasedRandomString();\n        $CategoryObj->Save();\n    }\n    // Prepare the result we will send to the front end\n    $this->setResult(true);\n    $this->setReturnValue("ReturnData", "$TicketDataSize Tickets created");\n    $this->presentOutput();\n}\n')),Object(o.b)("p",null,"Every time we run this function, we are generating 500 new tickets, 8 new categories and 50 new accounts. Note that the way we executed our loop, the tickets will not be generated with uniform distribution of categories or accounts, as the oldest generated accounts and categories will be sampled more often. But since we are just doing this to get some data, we are not worried about that."),Object(o.b)("h3",{id:"function-2"},"Function 2"),Object(o.b)("strong",null,"Return all tickets in the category defined by the user in the additional input box. The default category should be 'Personal' if no input provided. "),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'// Return all tickets in the category specified in the input box\npublic function Function2() {\n    // User input for which category to sort by.\n    $CategoryInputStr = $this->getInputValue("additional_input");\n    // Set default to "Personal"\n    if (is_null($CategoryInputStr) || !strlen($CategoryInputStr)) {\n        $CategoryInputStr = "Personal";\n    }\n    // dxQuery to return all tickets whose category matches the input category.\n    // Note: $TicketArray is an array of individual ticket objects.\n    $TicketArray = Ticket::QueryArray(\n        dxQ::Equal(\n            dxQN::Ticket()->CategoryObject->CategoryLabel,\n            $CategoryInputStr\n        )\n    );\n    // Create an array of the ticket objects with wanted category.\n    // Note: we convert each ticket object into a JSON object\n    // getJSON() returns the values in question in JSON (removing all methods).\n    // We then decode the JSON object and append it to our $ResultArray. This is\n    // because dxRequestInternal() already handles the JSON type conversions.\n    $ReturnArray = [];\n    foreach($TicketArray as $TicketObj) {\n        $ReturnArray[] = json_decode($TicketObj->getJson());\n    }\n    // Set what we are returning to the front end\n    $this->setResult(true);\n    $this->setReturnValue("ReturnData", $ReturnArray);\n    $this->presentOutput();\n}\n')),Object(o.b)("h3",{id:"function-3"},"Function 3"),Object(o.b)("strong",null,"Return all tickets where the Account's first name is specified in the additional input box (Default value is 'John') and the ticket status is \"In Progress\" "),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'// Return all tickets where the account\'s first name is specified in the input box and\n// the ticket\'s status is <em>In Progress</em>\npublic function Function3() {\n  // User input for which Name to sort by.\n    $FirstNameStr = $this->getInputValue("additional_input");\n    // Set default name to \'John\'\n    if (is_null($FirstNameStr) || !strlen($FirstNameStr)) {\n        $FirstNameStr = "John";\n    }\n    // dxQuery to return all tickets whose name matches the input name AND\n    // whose ticket status is \'In Progress\'\n    $TicketArray = Ticket::QueryArray(\n        dxQ::AndCondition(\n            dxq::Equal(\n                dxqN::Ticket()->AccountObject->FirstName,\n                $FirstNameStr\n            ),\n            dxq::Equal(\n                dxqN::Ticket()->TicketStatus,\n                "In Progress"\n            )\n        )\n    );\n    $ReturnArray = [];\n    foreach($TicketArray as $TicketObj) {\n        $ReturnArray[] = json_decode($TicketObj->getJson());\n    }\n    $this->setResult(true);\n    $this->setReturnValue("ReturnData", $ReturnArray);\n    $this->presentOutput();\n}\n')),Object(o.b)("h3",{id:"function-4"},"Function 4"),Object(o.b)("strong",null,'Return all tickets that have a status of "Completed" for the current month '),Object(o.b)("p",null,"This function is slightly trickier as we are now trying to sort by date. There are many ways to try do this, but we will use built-in Divblox functions to make this easier. The 'trick' here would be to be familiar and comfortable with what ",Object(o.b)("inlineCode",{parentName:"p"},"dxDateTime")," can offer you. All we do below is:"),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Set the StartDate to today's year and month but manually change the day to 1 and time to ",Object(o.b)("inlineCode",{parentName:"li"},"00:00:00"),"."),Object(o.b)("li",{parentName:"ol"},"Set the EndDate to StartDate, + 1 month, - 1 second (which is then just the last day of the current month)")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'// Return all tickets that have a status Completed where the due\n// date is in the current month, ordered by TicketDueDate ascending\npublic function Function4() {\n    // Define start and end of current month\n    $StartDateObj = dxDateTime::Now()->setDate(dxDateTime::Now()->format("Y"), dxDateTime::Now()->format("m"), 1)->setTime(0,0,0);\n    $EndDateObj = dxDateTime::Now()->setDate(dxDateTime::Now()->format("Y"), dxDateTime::Now()->format("m"), 1)->setTime(0,0,0);\n    $EndDateObj->addMonths(1);\n    $EndDateObj->addSeconds(-1);\n    // Slightly more complex dxQuery with 3 parts to the AND clause, as well as\n    // and OrderBy Clause to sort by TicketDueDate ascending\n    $TicketArray = Ticket::QueryArray(\n        dxQ::AndCondition(\n            dxq::Equal(\n                dxqN::Ticket()->TicketStatus,\n                "Completed"\n            ),\n            dxQ::GreaterOrEqual(\n                dxqN::Ticket()->TicketDueDate,\n                $StartDateObj\n            ),\n            dxQ::LessOrEqual(\n                dxqN::Ticket()->TicketDueDate,\n                $EndDateObj\n            )\n        ),\n        dxQ::Clause(\n            dxQ::OrderBy(\n                dxqN::Ticket()->TicketDueDate,\n                true\n            )\n        )\n    );\n    $ReturnArray = [];\n    foreach($TicketArray as $TicketObj) {\n        $ReturnArray[] = json_decode($TicketObj->getJson());\n    }\n    $this->setResult(true);\n    $this->setReturnValue("ReturnData", $ReturnArray);\n    $this->presentOutput();\n}\n')),Object(o.b)("h3",{id:"function-5"},"Function 5"),Object(o.b)("strong",null,'Return a list of "Account" full names with a count of tickets that they each currently have "In Progress" '),Object(o.b)("p",null,"In this function we first request an array of all Account objects. We then loop through each of those objects, and fill a key-value pair array as ","[FullName => NrTicketsInProgress]"," which is our expected result."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'// Return a list of account full names with a count of tickets that\n// they each currently have <em>In Progress</em>.\npublic function Function5() {\n    // Returns an array of all Account objects\n    $AccountArray = Account::QueryArray(\n        dxQ::All()\n    );\n    //Same results as: $AccountArray = Account::LoadAll();\n    $ReturnArray = [];\n    foreach ($AccountArray as $AccountObj) {\n        $ReturnArray[$AccountObj->FullName] = Ticket::QueryCount(\n            dxQ::Equal(\n                dxQN::Ticket()->AccountObject->Id,\n                $AccountObj->Id\n            )\n        );\n    }\n    $this->setResult(true);\n    $this->setReturnValue("ReturnData", $ReturnArray);\n    $this->presentOutput();\n}\n')),Object(o.b)("h3",{id:"function-6"},"Function 6"),Object(o.b)("strong",null,'Return a list of "Account" email addresses. For each account, show an array of categories. For each "Category" in the array, show the total count of all tickets for that category as well as the count for the specific account '),Object(o.b)("p",null,"You will end up with a nested array of objects, structured something like this:"),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"Function 6 diagram",src:Object(r.a)("_divblox-best-practices-media/example-bottom-nav2.png")})),Object(o.b)("p",null,"For each account (defined by it's email address) we want to see an array of all the categories used in their tickets. For each of those account-used categories, we want to see both the category's total tickets, as well as the account's category total ticket count."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'public function Function6() {\n    // Get Array of Account objects and array of Category objects\n    $AccountArray = Account::QueryArray(\n        dxQ::All()\n    );\n    $CategoryArray = Category::QueryArray(\n        dxQ::All()\n    );\n    $ReturnArray = [];\n    //Note Array indexing, refer to above diagram for visual aid of data structure\n    foreach ($AccountArray as $AccountObj) {\n        $ReturnArray[$AccountObj->EmailAddress] = [];\n        foreach ($CategoryArray as $CategoryObj) {\n            // For each account and each category, we find the two totals\n            $TotalCountInt = Ticket::QueryCount(\n                dxQ::Equal(\n                    dxQN::Ticket()->CategoryObject->CategoryLabel,\n                    $CategoryObj->CategoryLabel\n                )\n            );\n            $AccountCountInt = Ticket::QueryCount(\n                dxQ::AndCondition(\n                    dxQ::Equal(\n                        dxQN::Ticket()->CategoryObject->CategoryLabel,\n                        $CategoryObj->CategoryLabel\n                    ),\n                    dxQ::Equal(\n                        dxQN::Ticket()->AccountObject->Id,\n                        $AccountObj->Id\n                    )\n                )\n            );\n            // For each account->category pair, we add the two total values\n            $ReturnArray[$AccountObj->EmailAddress][$CategoryObj->CategoryLabel] =\n              ["GrandTotal"=> $TotalCountInt, "AccountTotal"=> $AccountCountInt];\n        }\n    }\n    $this->setResult(true);\n    $this->setReturnValue("ReturnData", $ReturnArray);\n    $this->presentOutput();\n}\n')),Object(o.b)("h3",{id:"function-7"},"Function 7"),Object(o.b)("strong",null,"Optimize the query in Function 6 using the Select Clause and by reducing the number of iterations in the loop. You can use your browser's dev tools to monitor the time taken to execute the query. "),Object(o.b)("ol",null,Object(o.b)("li",{parentName:"ol"},"Select only the necessary attribute from Account entity, i.e. EmailAddress. This means that we are only returning a single column from the database. NOTE: Even though you only select one column, the Account primary key is still included for indexed searching."),Object(o.b)("li",{parentName:"ol"},"We only calculate the GrandTotal once for every Category, instead of re-checking and re-saving it every time we loop over an account, which has a ticket with said category.")),Object(o.b)("p",null,"The new code can be seen below:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'// Optimizes function 6 to return its query result quicker\n    public function Function7() {\n        // Optimization 1 : Select only the necessary attribute from\n        // Account entity, i.e. EmailAddress.\n        $AccountArray = Account::QueryArray(\n            dxQ::All(),\n            dxQ::Clause(\n                dxQ::Select(\n                    dxQN::Account()->EmailAddress\n                )\n            )\n        );\n        $CategoryArray = Category::QueryArray(\n            dxQ::All()\n        );\n        $ReturnArray = [];\n        $TotalCountArray = [];\n        foreach ($AccountArray as $AccountObj) {\n            $ReturnArray[$AccountObj->EmailAddress] = [];\n            foreach ($CategoryArray as $CategoryObj) {\n                // Optimization 2: Only check TotalCount once for each category\n                if (!isset($TotalCountArray[$CategoryObj->Id])) {\n                    $TotalCountArray[$CategoryObj->Id] = Ticket::QueryCount(\n                        dxQ::Equal(\n                            dxQN::Ticket()->CategoryObject->Id,\n                            $CategoryObj->Id\n                        )\n                    );\n                }\n                $AccountCountInt = Ticket::QueryCount(\n                    dxQ::AndCondition(\n                        dxQ::Equal(\n                            dxQN::Ticket()->CategoryObject->Id,\n                            $CategoryObj->Id\n                        ),\n                        dxQ::Equal(\n                            dxQN::Ticket()->AccountObject->Id,\n                            $AccountObj->Id\n                        )\n                    ),\n                    dxQ::Clause(\n                        dxQ::Select(\n                            dxqN::Ticket()->Id\n                        )\n                    )\n                );\n                $ReturnArray[$AccountObj->EmailAddress][$CategoryObj->CategoryLabel] =\n                 ["GrandTotal"=> $TotalCountArray[$CategoryObj->Id], "AccountTotal"=> $AccountCountInt];\n            }\n        }\n        $this->setResult(true);\n        $this->setReturnValue("ReturnData", $ReturnArray);\n        $this->presentOutput();\n    }\n')),Object(o.b)("p",null,"Using the browser's network monitoring tool, the difference with just these minor changes can already be seen. Below is a screenshot of the times taken with the two methods. 5 observations were taken for a better average. There are much better and more in-depth ways to test your code efficiency, but for this example a rough visual difference is all we need. The time taken is dependent on the hardware of your machine, as well as how big your database is. So if your times are different, don't worry, as long as you can see a visible decrease in time taken."),Object(o.b)("div",{className:"text--center"},Object(o.b)("img",{alt:"bte-8-8TimeComparison",src:Object(r.a)("_basic-training-media/bte-8-8-time_comparison.png")})),Object(o.b)("h3",{id:"final-optimizations"},"Final Optimizations"),Object(o.b)("p",null,"In this last step, we will have to change our data model slightly. Let us include the ",Object(o.b)("inlineCode",{parentName:"p"},"TicketCount")," attribute into the ",Object(o.b)("inlineCode",{parentName:"p"},"Category")," entity, which will represent the total number of tickets in the category in question, and will be updated as tickets are saved and deleted. Using Divblox's data modeller, this process is simple and all the user needs to do is add the attribute and sync to the database, which updates the database and regenerates all the classes and necessary functionality code."),Object(o.b)("p",null,"This optimization is intended for when our dataset becomes extremely large, and the cost of making even an optimized query in a loop becomes too high. In this optimization we are focusing on preparing our data for reporting purposes rather than aggregating after the fact."),Object(o.b)("p",null,"We will need to write the functionality that calculates the ",Object(o.b)("inlineCode",{parentName:"p"},"TicketCount")," into the ",Object(o.b)("inlineCode",{parentName:"p"},"Save()")," and ",Object(o.b)("inlineCode",{parentName:"p"},"Delete()")," functions of the Ticket ORM class, meaning that any time a ticket is saved or deleted, the ",Object(o.b)("inlineCode",{parentName:"p"},"TicketCount")," will be updated. We can do this by overriding their default behaviour defined in ",Object(o.b)("inlineCode",{parentName:"p"},"TicketGen.class.php")," (",Object(o.b)("inlineCode",{parentName:"p"},"divblox/config/database/data_model_orm/generated/TicketGen.class.php"),") in ",Object(o.b)("inlineCode",{parentName:"p"},"Ticket.class.php")," (",Object(o.b)("inlineCode",{parentName:"p"},"divblox/config/database/data_model_orm/Ticket.class.php"),"). We do this in accordance with the Divblox code-generation philosophy: never touch auto-generated files, but rather add functionality in classes that extend base Divblox functionality to prevent loss of work."),Object(o.b)("p",null,"The code added to the class ",Object(o.b)("inlineCode",{parentName:"p"},"Ticket")," which extends the class ",Object(o.b)("inlineCode",{parentName:"p"},"TicketGen")," was:"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"public function Save($blnForceInsert = false, $blnForceUpdate = false) {\n    // This step ensures that all of the original Save functionality is still carried out.\n    $mixToReturn = parent::Save($blnForceInsert,$blnForceUpdate);\n\n    $CategoryObj = Category::Load($this->intCategory);\n    //If the category exists, calculate the total\n    if (!is_null($CategoryObj)) {\n        $TicketCount = Ticket::QueryCount(\n            dxQ::Equal(\n                dxQN::Ticket()->CategoryObject->Id,\n                $CategoryObj->Id\n            )\n        );\n        // Write it into local storage, and save into database\n        $CategoryObj->TicketCount = $TicketCount;\n        $CategoryObj->Save();\n    }\n    // Return\n    return $mixToReturn;\n}\n")),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),"public function Delete() {\n    // For delete, we first load the category since after it is deleted\n    // we won't be able to know which category the ticket was in.\n    $CategoryObj = Category::Load($this->intCategory);\n    parent::Delete();\n    // If category exists, calculate the total\n    if (!is_null($CategoryObj)) {\n        $TicketCount = Ticket::QueryCount(\n            dxQ::Equal(\n                dxQN::Ticket()->CategoryObject->Id,\n                $CategoryObj->Id\n            )\n        );\n        // Write it into local storage, and save into database\n        $CategoryObj->TicketCount = $TicketCount;\n        $CategoryObj->Save();\n    }\n}\n")),Object(o.b)("p",null,"This is great. Now every time we create or delete a ticket, our counter will automatically update. But what do we do about the tickets that already exist in our database? We will have to create a throwaway script to run once to account for all the already existing tickets in our database."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'require("divblox/divblox.php");\n// Select All Categories\n$CategoryArray = Category::QueryArray(\n    dxQ::All()\n);\n// For each unique category, calculate the total number of tickets\n// which have that category\nforeach ($CategoryArray as $CategoryObj) {\n    $TicketCount = Ticket::QueryCount(\n        dxQ::Equal(\n            dxQN::Ticket()->CategoryObject->Id,\n            $CategoryObj->Id\n        )\n    );\n    // save $TicketCount into localstorage and into database.\n    $CategoryObj->TicketCount = $TicketCount;\n    $CategoryObj->Save();\n}\n')),Object(o.b)("p",null,"This script can be saved anywhere and run by going to ",Object(o.b)("inlineCode",{parentName:"p"},"localhost/[your_project]/[path_to_script]/throwaway.php")," in your browser. You can confirm that it performed what it was supposed to by checking the category table in phpMyAdmin."),Object(o.b)("p",null,"Now, the final step is to go back to our code and just reference the TicketCount attribute instead of calculating the TicketCount total every time. This shouldn't really affect our speed significantly until we have a ",Object(o.b)("em",{parentName:"p"},"very")," large data set, but was included for good practice."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-php"}),'public function Function7() {\n        $AccountArray = Account::QueryArray(\n            dxQ::All(),\n            dxQ::Clause(\n                dxQ::Select(\n                    dxQN::Account()->EmailAddress\n                )\n            )\n        );\n        $CategoryArray = Category::QueryArray(\n            dxQ::All()\n        );\n        $ReturnArray = [];\n        foreach ($AccountArray as $AccountObj) {\n            $ReturnArray[$AccountObj->EmailAddress] = [];\n            foreach ($CategoryArray as $CategoryObj) {\n                $AccountCountInt = Ticket::QueryCount(\n                    dxQ::AndCondition(\n                        dxQ::Equal(\n                            dxQN::Ticket()->CategoryObject->Id,\n                            $CategoryObj->Id\n                        ),\n                        dxQ::Equal(\n                            dxQN::Ticket()->AccountObject->Id,\n                            $AccountObj->Id\n                        )\n                    ),\n                    dxQ::Clause(\n                        dxQ::Select(\n                            dxqN::Ticket()->Id\n                        )\n                    )\n                );\n                $ReturnArray[$AccountObj->EmailAddress][$CategoryObj->CategoryLabel] =\n                    ["GrandTotal"=> $CategoryObj->TicketCount, "AccountTotal"=> $AccountCountInt];\n            }\n        }\n        $this->setResult(true);\n        $this->setReturnValue("ReturnData", $ReturnArray);\n        $this->presentOutput();\n    }\n')),Object(o.b)("h2",{id:"summary"},"Summary"),Object(o.b)("p",null,"In this exercise you learned about all the basic elements of a Divblox project. If you understand step 1 - 8 completely, you should have a fundamental understanding of the basics of any Divblox application."),Object(o.b)("p",null,"If you would like to receive further hands-on training from the Divblox team, please reach out to us at ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"mailto:support@divblox.com"}),"support@divblox.com")," and we will arrange a consultation."))}b.isMDXComponent=!0},189:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return h}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function c(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=i.a.createContext({}),u=function(e){var t=i.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):c(c({},t),e)),n},d=function(e){var t=u(e.components);return i.a.createElement(s.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},p=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,s=l(e,["components","mdxType","originalType","parentName"]),d=u(n),p=a,h=d["".concat(r,".").concat(p)]||d[p]||b[p]||o;return n?i.a.createElement(h,c(c({ref:t},s),{},{components:n})):i.a.createElement(h,c({ref:t},s))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=p;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c.mdxType="string"==typeof e?e:a,r[1]=c;for(var s=2;s<o;s++)r[s]=n[s];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},190:function(e,t,n){"use strict";var a=n(0),i=n(52);t.a=function(){return Object(a.useContext)(i.a)}},191:function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));n(79);var a=n(190),i=n(193);function o(e,t){var n=void 0===t?{}:t,o=n.forcePrependBaseUrl,r=void 0!==o&&o,c=n.absolute,l=void 0!==c&&c,s=Object(a.a)().siteConfig,u=(s=void 0===s?{}:s).baseUrl,d=void 0===u?"/":u,b=s.url;if(!e)return e;if(r)return d+e;if(!Object(i.a)(e))return e;var p=d+e.replace(/^\//,"");return l?b+p:p}},192:function(e,t,n){"use strict";function a(e){var t,n,i="";if("string"==typeof e||"number"==typeof e)i+=e;else if("object"==typeof e)if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(n=a(e[t]))&&(i&&(i+=" "),i+=n);else for(t in e)e[t]&&(i&&(i+=" "),i+=t);return i}t.a=function(){for(var e,t,n=0,i="";n<arguments.length;)(e=arguments[n++])&&(t=a(e))&&(i&&(i+=" "),i+=t);return i}},193:function(e,t,n){"use strict";function a(e){return!1===/^(https?:|\/\/|mailto:|tel:)/.test(e)}n.d(t,"a",(function(){return a}))},194:function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));n(78),n(0);var a=function(){setTimeout((function(){if("undefined"!=typeof window){var e=window.location.href.split("#");if(e.length>1){var t=e[1];document.getElementById(t).scrollIntoView()}}}),500)}},195:function(e,t,n){"use strict";var a=n(0),i=Object(a.createContext)({tabGroupChoices:{},setTabGroupChoices:function(){},isAnnouncementBarClosed:!1,closeAnnouncementBar:function(){}});t.a=i},196:function(e,t,n){"use strict";var a=n(0),i=n(195);t.a=function(){return Object(a.useContext)(i.a)}},197:function(e,t,n){"use strict";n(24),n(20),n(19);var a=n(0),i=n.n(a),o=n(196),r=n(192),c=n(130),l=n.n(c),s=37,u=39;t.a=function(e){var t=e.block,n=e.children,c=e.defaultValue,d=e.values,b=e.groupId,p=Object(o.a)(),h=p.tabGroupChoices,m=p.setTabGroupChoices,g=Object(a.useState)(c),j=g[0],O=g[1];if(null!=b){var y=h[b];null!=y&&y!==j&&d.some((function(e){return e.value===y}))&&O(y)}var f=function(e){O(e),null!=b&&m(b,e)},w=[];return i.a.createElement("div",null,i.a.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:Object(r.a)("tabs",{"tabs--block":t})},d.map((function(e){var t=e.value,n=e.label;return i.a.createElement("li",{role:"tab",tabIndex:"0","aria-selected":j===t,className:Object(r.a)("tabs__item",l.a.tabItem,{"tabs__item--active":j===t}),key:t,ref:function(e){return w.push(e)},onKeyDown:function(e){return function(e,t,n){switch(n.keyCode){case u:!function(e,t){var n=e.indexOf(t)+1;e[n]?e[n].focus():e[0].focus()}(e,t);break;case s:!function(e,t){var n=e.indexOf(t)-1;e[n]?e[n].focus():e[e.length-1].focus()}(e,t)}}(w,e.target,e)},onFocus:function(){return f(t)},onClick:function(){return f(t)}},n)}))),i.a.createElement("div",{role:"tabpanel",className:"margin-vert--md"},a.Children.toArray(n).filter((function(e){return e.props.value===j}))[0]))}},198:function(e,t,n){"use strict";var a=n(0),i=n.n(a);t.a=function(e){return i.a.createElement("div",null,e.children)}}}]);